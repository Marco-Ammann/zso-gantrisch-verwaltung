<!-- src/app/modules/ausbildungen/ausbildungsmatrix/ausbildungsmatrix.component.html -->
<div class="ausbildungsmatrix-container">
    <div class="header-section">
      <h1 class="page-title">Ausbildungsmatrix</h1>
      
      <div class="action-buttons">
        <button 
          mat-stroked-button 
          color="primary" 
          (click)="exportCsv()"
          [disabled]="isLoading() || matrixData().length === 0">
          <mat-icon>download</mat-icon>
          Als CSV exportieren
        </button>
      </div>
    </div>
    
    @if (isLoading()) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Daten werden geladen...</p>
      </div>
    } @else {
      <!-- Filter-Karte -->
      <mat-card class="filter-card">
        <mat-card-content>
          <div class="filter-container">
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Jahr</mat-label>
              <mat-select [formControl]="jahrFilter">
                <mat-option [value]="null">Alle Jahre</mat-option>
                @for (jahr of jahrOptions; track jahr) {
                  <mat-option [value]="jahr">{{ jahr }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Typ</mat-label>
              <mat-select [formControl]="typFilter">
                @for (option of typOptions; track option.value) {
                  <mat-option [value]="option.value">{{ option.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            
            <mat-form-field appearance="outline" class="search-field">
              <mat-label>Suchen</mat-label>
              <input 
                matInput 
                [formControl]="searchControl"
                placeholder="Nach Personen filtern...">
              <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>
      
      <!-- Matrix-Tabelle -->
      <mat-card class="matrix-card">
        <mat-card-content>
          @if (matrixData().length === 0) {
            <div class="no-data-message">
              <mat-icon>info</mat-icon>
              <p>Keine Daten für die ausgewählten Filter gefunden.</p>
            </div>
          } @else {
            <div class="table-container">
              <table mat-table [dataSource]="dataSource" matSort class="matrix-table">
                
                <!-- Name Spalte -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header="person.grunddaten.nachname" class="name-column">
                    Betreuer
                  </th>
                  <td 
                    mat-cell 
                    *matCellDef="let row" 
                    class="name-cell" 
                    (click)="viewPerson(row.person)">
                    <div class="person-info">
                      <div class="person-name">
                        {{ row.person.grunddaten.grad }} {{ row.person.grunddaten.nachname }} {{ row.person.grunddaten.vorname }}
                      </div>
                      <div class="person-additional">
                        {{ row.person.grunddaten.funktion }} | Zug {{ row.person.zivilschutz.einteilung.zug }}
                      </div>
                    </div>
                  </td>
                </ng-container>
                
                <!-- Dynamische Spalten für Ausbildungen -->
                @for (column of displayedColumns(); track column; let i = $index) {
                  @if (column !== 'name') {
                    <ng-container [matColumnDef]="column">
                      <th 
                        mat-header-cell 
                        *matHeaderCellDef 
                        class="ausbildung-column"
                        (click)="viewAusbildung(column)">
                        <div class="ausbildung-header">
                          <div class="ausbildung-title">{{ getAusbildungTitel(column) }}</div>
                          <div class="ausbildung-type-badge" [ngClass]="'typ-' + getAusbildungTyp(column)">
                            {{ getAusbildungTyp(column) }}
                          </div>
                        </div>
                      </th>
                      <td mat-cell *matCellDef="let row">
                        @if (getTeilnahmeInfo(row, column)) {
                          <div 
                            class="teilnahme-cell"
                            [ngClass]="getTeilnahmeClass(getTeilnahmeInfo(row, column)?.status)"
                            [matTooltip]="
                              'Status: ' + (getTeilnahmeInfo(row, column)?.status || '') + 
                              (getTeilnahmeInfo(row, column)?.bemerkung ? '\nBemerkung: ' + getTeilnahmeInfo(row, column)?.bemerkung : '') +
                              '\nDatum: ' + formatDate(getTeilnahmeInfo(row, column)?.datum)
                            ">
                            <mat-icon>{{ getTeilnahmeIcon(getTeilnahmeInfo(row, column)?.status) }}</mat-icon>
                          </div>
                        } @else {
                          <div class="teilnahme-cell empty" matTooltip="Keine Teilnahme">
                            <mat-icon>remove</mat-icon>
                          </div>
                        }
                      </td>
                    </ng-container>
                  }
                }
                
                <!-- Tabellenzeilen -->
                <tr mat-header-row *matHeaderRowDef="displayedColumns(); sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns();"></tr>
                
                <!-- Keine Daten -->
                @if (dataSource.filteredData.length === 0) {
                  <tr class="mat-row no-data-row">
                    <td 
                      class="mat-cell no-data-cell" 
                      [attr.colspan]="displayedColumns().length"
                    >
                      <div class="no-data-message">
                        <mat-icon>search_off</mat-icon>
                        <span>Keine Ergebnisse für den angegebenen Filter</span>
                      </div>
                    </td>
                  </tr>
                }
              </table>
            </div>
            
            <!-- Paginierung -->
            <mat-paginator 
              [pageSizeOptions]="[10, 25, 50, 100]" 
              showFirstLastButtons>
            </mat-paginator>
          }
        </mat-card-content>
      </mat-card>
      
      <!-- Erklärung der Symbole -->
      <mat-card class="legend-card">
        <mat-card-content>
          <div class="legend-title">Legende:</div>
          <div class="legend-container">
            <div class="legend-item">
              <div class="teilnahme-cell teilgenommen">
                <mat-icon>check_circle</mat-icon>
              </div>
              <div class="legend-text">Teilgenommen</div>
            </div>
            
            <div class="legend-item">
              <div class="teilnahme-cell dispensiert">
                <mat-icon>warning</mat-icon>
              </div>
              <div class="legend-text">Dispensiert</div>
            </div>
            
            <div class="legend-item">
              <div class="teilnahme-cell nicht-teilgenommen">
                <mat-icon>cancel</mat-icon>
              </div>
              <div class="legend-text">Nicht teilgenommen</div>
            </div>
            
            <div class="legend-item">
              <div class="teilnahme-cell empty">
                <mat-icon>remove</mat-icon>
              </div>
              <div class="legend-text">Keine Teilnahme erfasst</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>